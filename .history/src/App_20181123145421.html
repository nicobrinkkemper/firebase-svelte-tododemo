<div class="row">
	<div class="col-md-12">
		<br />
		<div class="input-group">
			<input class="form-control text" type="text" required="{true}" value="{data.todo.text}" placeholder="Write a todo" onKeyUp="{onSubmit}"
			 onChange={onTextChange} />

			<select class="form-control priority" value={todo.priority || 0} onChange={onPriorityChange}>
				<option value="0">{constants.PRIORITY[0]}</option>
				<option value="1">{constants.PRIORITY[1]}</option>
				<option value="2">{constants.PRIORITY[2]}</option>
			</select>
			<div class="input-group-append">
				<button class="btn btn-primary" onClick={onAdd}>
					Add
				</button>
			</div>
		</div>
	</div>
</div>
{#if todos.length > 0}
<section class="main">
	<input id="toggle-all" class="toggle-all" type="checkbox" on:change='toggleAll(this.checked)' checked='{numCompleted === todos.length}'>
	<label for="toggle-all">Mark all as complete</label>

	<ul class="todo-list">
		{#each todos as item, index} {#if filter(item, currentFilter)}
		<li class="{item.completed ? 'completed' : ''} {editing === index ? 'editing' : ''}">
			<div class="view">
				<input class="toggle" type="checkbox" bind:checked="item.completed">
				<label on:dblclick="edit(index)">{item.description}</label>
				<button on:click="remove(index)" class="destroy"></button>
			</div>

			{#if editing === index}
			<input value='{item.description}' id="edit" class="edit" on:enter='blur(this)' on:blur="submit(this.value)" on:escape="cancel()"
			/> {/if}
		</li>
		{/if} {/each}
	</ul>

	<footer class="footer">
		<span class="todo-count">
			<strong>{numActive}</strong> {numActive === 1 ? 'item' : 'todos'} left
		</span>

		<ul class="filters">
			<li><a class="{currentFilter === 'all' ? 'selected' : ''}" href="#/">All</a></li>
			<li><a class="{currentFilter === 'active' ? 'selected' : ''}" href="#/active">Active</a></li>
			<li><a class="{currentFilter === 'completed' ? 'selected' : ''}" href="#/completed">Completed</a></li>
		</ul>

		{#if numCompleted}
		<button class="clear-completed" on:click="clearCompleted()">
			Clear completed
		</button>
		{/if}
	</footer>
</section>
{/if}

<script>
	const ENTER_KEY = 13;
	const ESCAPE_KEY = 27;
	function keyEvent(code) {
	  return function(node, callback) {
	    function keydownHandler(event) {
	      if (event.which === code) callback.call(this, event);
	    }
	    node.addEventListener("keydown", keydownHandler, false);
	    return {
	      destroy() {
	        node.removeEventListener("keydown", keydownHandler, false);
	      }
	    };
	  };
	}
	let todos;
	try {
	  todos = JSON.parse(localStorage.getItem("todos-svelte")) || [];
	} catch (err) {
	  todos = [];
	}
	export default {
	  data: () => {
	    return {
	      currentFilter: "all",
	      todo: {
	        text: "",
	        datetime: new Date(),
	        priority: 0
		  },
		  todos
	    };
	  },
	  computed: {
	    numActive: ({ todos }) => todos.filter(item => !item.completed).length,
	    numCompleted: ({ todos }) => todos.filter(item => item.completed).length
	  },
	  helpers: {
	    filter(item, currentFilter) {
	      if (currentFilter === "all") return true;
	      if (currentFilter === "completed") return item.completed;
	      if (currentFilter === "active") return !item.completed;
	    }
	  },
	  oncreate() {
	    const updateView = () => {
	      let currentFilter = "all";
	      if (window.location.hash === "#/active") {
	        currentFilter = "active";
	      } else if (window.location.hash === "#/completed") {
	        currentFilter = "completed";
	      }
	      this.set({ currentFilter });
	    };
	    window.addEventListener("hashchange", updateView);
	    updateView();
	  },
	  onstate({ changed, current, previous }) {
	    if (previous && changed.todos) {
	      try {
	        localStorage.setItem("todos-svelte", JSON.stringify(current.todos));
	      } catch (err) {
	        // noop
	      }
	    }
	  },
	  methods: {
	    onTextChange(text) {
	      const { todo } = this.get();
	      this.set({ todo: { ...todo, text } });
	    },
	    onSubmit() {},
	    onPriorityChange(priority) {
	      const { todo } = this.get();
	      this.set({ todo: { ...todo, priority } });
	    },
	    onAdd() {
	      console.log("hi");
	    },
	    blur(node) {
	      node.blur();
	    },
	    cancel() {
	      this.set({ editing: null });
	    },
	    clearCompleted() {
	      const todos = this.get().todos.filter(item => !item.completed);
	      this.set({ todos });
	    },
	    edit(index) {
	      this.set({ editing: index });
	    },
	    newTodo(description) {
	      const { todos } = this.get();
	      todos.push({
	        description,
	        completed: false
	      });
	      this.set({ todos });
	      this.refs.newTodo.value = "";
	    },
	    remove(index) {
	      const { todos } = this.get();
	      todos.splice(index, 1);
	      this.set({ todos });
	    },
	    submit(description) {
	      const { todos } = this.get();
	      const index = this.get().editing;
	      todos[index].description = description;
	      this.set({ todos, editing: null });
	    },
	    toggleAll(checked) {
	      const { todos } = this.get();
	      todos.forEach(item => {
	        item.completed = checked;
	      });
	      this.set({ todos });
	    }
	  },
	  events: {
	    enter: keyEvent(ENTER_KEY),
	    escape: keyEvent(ESCAPE_KEY)
	  }
	};
</script>